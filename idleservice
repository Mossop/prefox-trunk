# HG changeset patch
# User Dave Townsend <dtownsend@oxymoronical.com>
# Date 1278552764 25200
# Node ID 411ee064b3cb7c40df0bef3fe8bce3e3778fe794
# Parent b725af3310ea6b604ab904a29d6f9bd8924983ec
[palm] Add an idle service

diff --git a/widget/src/webos/Makefile.in b/widget/src/webos/Makefile.in
--- a/widget/src/webos/Makefile.in
+++ b/widget/src/webos/Makefile.in
@@ -60,6 +60,7 @@ CPPSRCS	= \
 	nsWindow.cpp \
 	nsLookAndFeel.cpp \
 	nsScreenManager.cpp \
+	nsIdleServiceWebOS.cpp \
 	$(NULL)
 
 NOT_THERE_YET_CPPSRCS = \
@@ -71,7 +72,6 @@ NOT_THERE_YET_CPPSRCS = \
 	mozqwidget.cpp \
 	nsSound.cpp \
 	nsFilePicker.cpp \
-	nsIdleService.cpp \
 	nsAccelerometer.cpp \
 	$(NULL)
 
diff --git a/widget/src/webos/nsIdleServiceWebOS.cpp b/widget/src/webos/nsIdleServiceWebOS.cpp
new file mode 100644
--- /dev/null
+++ b/widget/src/webos/nsIdleServiceWebOS.cpp
@@ -0,0 +1,63 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/* vim:expandtab:shiftwidth=4:tabstop=4:
+ */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is mozilla.org code.
+ *
+ * The Initial Developer of the Original Code is
+ * Gijs Kruitbosch <gijskruitbosch@gmail.com>.
+ * Portions created by the Initial Developer are Copyright (C) 2007
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Michael Wu <mwu@mozilla.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#include "nsIdleServiceWebOS.h"
+#include "nsIServiceManager.h"
+
+NS_IMPL_ISUPPORTS1(nsIdleServiceWebOS, nsIIdleService)
+
+nsIdleServiceWebOS::nsIdleServiceWebOS()
+{
+}
+
+nsIdleServiceWebOS::~nsIdleServiceWebOS()
+{
+}
+
+NS_IMETHODIMP
+nsIdleServiceWebOS::GetIdleTime(PRUint32 *aTimeDiff)
+{
+    extern PRUint32 gLastInputEventTime;
+
+    PRUint32 nowTime = PR_IntervalToMicroseconds(PR_IntervalNow());
+    *aTimeDiff = (nowTime - gLastInputEventTime) / 1000;
+    return NS_OK;
+}
+
diff --git a/widget/src/webos/nsIdleServiceWebOS.h b/widget/src/webos/nsIdleServiceWebOS.h
new file mode 100644
--- /dev/null
+++ b/widget/src/webos/nsIdleServiceWebOS.h
@@ -0,0 +1,57 @@
+/* -*- Mode: C++; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- */
+/* vim:expandtab:shiftwidth=4:tabstop=4:
+ */
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is mozilla.org code.
+ *
+ * The Initial Developer of the Original Code is
+ * Gijs Kruitbosch <gijskruitbosch@gmail.com>.
+ * Portions created by the Initial Developer are Copyright (C) 2007
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *   Michael Wu <mwu@mozilla.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+#ifndef nsIdleServiceWebOS_h__
+#define nsIdleServiceWebOS_h__
+
+#include "nsIdleService.h"
+
+class nsIdleServiceWebOS : public nsIdleService
+{
+public:
+    NS_DECL_ISUPPORTS
+    nsIdleServiceWebOS();
+
+    NS_IMETHOD GetIdleTime(PRUint32* idleTime);
+private:
+    ~nsIdleServiceWebOS();
+};
+
+#endif // nsIdleServiceWebOS_h__
diff --git a/widget/src/webos/nsWidgetFactory.cpp b/widget/src/webos/nsWidgetFactory.cpp
--- a/widget/src/webos/nsWidgetFactory.cpp
+++ b/widget/src/webos/nsWidgetFactory.cpp
@@ -48,11 +48,13 @@
 #include "nsLookAndFeel.h"
 #include "nsAppShellSingleton.h"
 #include "nsScreenManager.h"
+#include "nsIdleServiceWebOS.h"
 
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsToolkit)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsWindow)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsLookAndFeel)
 NS_GENERIC_FACTORY_CONSTRUCTOR(nsScreenManager)
+NS_GENERIC_FACTORY_CONSTRUCTOR(nsIdleServiceWebOS)
 
 NS_DEFINE_NAMED_CID(NS_TOOLKIT_CID);
 NS_DEFINE_NAMED_CID(NS_APPSHELL_CID);
@@ -60,6 +62,7 @@ NS_DEFINE_NAMED_CID(NS_WINDOW_CID);
 NS_DEFINE_NAMED_CID(NS_CHILD_CID);
 NS_DEFINE_NAMED_CID(NS_LOOKANDFEEL_CID);
 NS_DEFINE_NAMED_CID(NS_SCREENMANAGER_CID);
+NS_DEFINE_NAMED_CID(NS_IDLE_SERVICE_CID);
 
 static const mozilla::Module::CIDEntry kWidgetCIDs[] = {
     { &kNS_TOOLKIT_CID, false, NULL, nsToolkitConstructor },
@@ -68,6 +71,7 @@ static const mozilla::Module::CIDEntry k
     { &kNS_CHILD_CID, false, NULL, nsWindowConstructor }, /* Note: same as Window! */
     { &kNS_LOOKANDFEEL_CID, false, NULL, nsLookAndFeelConstructor },
     { &kNS_SCREENMANAGER_CID, false, NULL, nsScreenManagerConstructor },
+    { &kNS_IDLE_SERVICE_CID, false, NULL, nsIdleServiceWebOSConstructor },
     { NULL }
 };
 
@@ -78,6 +82,7 @@ static const mozilla::Module::ContractID
     { "@mozilla.org/widgets/child_window/webos;1", &kNS_CHILD_CID },
     { "@mozilla.org/widget/lookandfeel/webos;1", &kNS_LOOKANDFEEL_CID },
     { "@mozilla.org/gfx/screenmanager;1", &kNS_SCREENMANAGER_CID },
+    { "@mozilla.org/widget/idleservice;1", &kNS_IDLE_SERVICE_CID },
     { NULL }
 };
 
diff --git a/widget/src/webos/nsWindow.cpp b/widget/src/webos/nsWindow.cpp
--- a/widget/src/webos/nsWindow.cpp
+++ b/widget/src/webos/nsWindow.cpp
@@ -626,6 +626,7 @@ nsWindow::OnSDLEvent(SDL_Event *sdlevt) 
     case SDL_MOUSEBUTTONDOWN:
     case SDL_MOUSEBUTTONUP:
     case SDL_MOUSEMOTION: {
+        gLastInputEventTime = PR_IntervalToMicroseconds(PR_IntervalNow());
         nsIntPoint pt(sdlevt->button.x, sdlevt->button.y);
         nsWindow* win = FindWindowForPoint(pt);
         win->OnMouseEvent(sdlevt, pt);
@@ -633,6 +634,7 @@ nsWindow::OnSDLEvent(SDL_Event *sdlevt) 
     }
     case SDL_KEYDOWN:
     case SDL_KEYUP:
+        gLastInputEventTime = PR_IntervalToMicroseconds(PR_IntervalNow());
         OnKeyEvent(sdlevt->key);
         break;
     }
